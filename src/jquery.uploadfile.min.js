/* @author Nener(http://nener.me)*/
(function(f){var e="uploadfile";var b=function(i){return"."+(i.split(".").pop().toLowerCase())};var g=function(j,i){if((!j)||j.length<=0||(!i)){return true}var k=b.call(this,i);if(f.inArray(k,j)<=-1){return false}return true};var c=function(l){var m=f(this),k=m.data(e),o=0;if(!k){f.error("uploadfile not init");return m}var i=new FormData(),j=f.extend(true,{},k.data,l),n=true;m.each(function(r){var q=f(this),t=q.get(0).files,p=q.attr("name");if((!t)||t.length<=0||(!q.val())){n=false;return false}for(var s=t.length-1;s>=0;s--){i.append(p+(o<=0?"":(o+"")),t[s]);o++}i.append("filepath"+(r<=0?"":r),q.val())});if(!n){return m}if(j){f.each(j,function(q,p){i.append(q,p)})}f.ajax({url:k.url,dataType:k.dataType,method:"post",data:i,timeout:k.timeout,processData:false,contentType:false,beforeSend:function(p){k.before.call(this,p)}}).done(function(p){k.success.call(this,p)}).fail(function(p){k.error.call(this,p)}).always(function(p){k.complete.call(this,p)});return m};var h=function(){var j=f(this),i=j.data(e);if(!g.call(j,i.accept,j.val())){i.selectError.call(j,j.val());j.val("");j.click()}return j};var d=function(){var j=f(this),i=j.data(e);if(j.val()){if(g.call(j,i.accept,j.val())){return c.call(this)}}};var a={init:function(j){var m=f.extend(true,{},f.fn.uploadfile.defaults,j),n=f(this);n.attr("required","required");n.attr("type","file");if(!m.file){if(!n.attr("name")){m.file="file"}else{m.file=n.attr("name")}}n.attr("name",m.file);if(m.accept&&m.accept.length>0){if(typeof(m.accept)==typeof([])){n.attr("accept",m.accept.join(",").toLowerCase());for(var l=m.accept.length-1;l>=0;l--){m.accept[l]=m.accept[l].toLowerCase()}}else{if(typeof(m.accept)==typeof("")){n.attr("accept",m.accept);m.accept=k&&k.toLowerCase().split(",")}else{m.accept=[];f.error("The options item accept type must be Array or string")}}}else{var k=n.attr("accept");m.accept=k&&k.toLowerCase().split(",")}n.data(e,m);n.off("change",h);n.on("change",h);n.off("change",d);if(m.autoUpload===true){n.on("change",d)}n.val("");return n},upload:function(i){var j=f(this);if(!j.val()){f.error("Your must chose a file upload");return j}return c.call(this,i)},destroy:function(){return f(this).each(function(){var i=f(this);i.removeData(e)})}};f.fn.uploadfile=function(){if(!FormData){f.error("Your browser is not support jQuery."+e);return this}var j=f(this),k=arguments[0],i;if(k===false){k=a.destroy;i=[]}else{if(typeof(k)=="object"||!k){k=a.init;i=arguments}else{if(k===true){k=a.upload;i=Array.prototype.slice.call(arguments,1)}else{if(a[k]){k=a[k];i=Array.prototype.slice.call(arguments,1)}else{f.error("Method "+k+" does not exist on jQuery."+e);return this}}}}return k.apply(this,i)};f.fn.uploadfile.defaults={url:"/",file:"file",accept:[],timeout:6000000,autoUpload:false,dataType:"json",data:{},selectError:function(i){alert("The file ["+i+"] not accept");return false},before:function(i){console.info("before upload file")},error:function(i){console.error("upload file error")},success:function(i){console.info("upload file success")},complete:function(i){console.info("upload file complete")}}})(jQuery);