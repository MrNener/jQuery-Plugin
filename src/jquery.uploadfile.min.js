/* @author Nener(http://nener.me)*/
(function(f,b){var g="uploadfile";var h=function(j){return"."+(j.split(".").pop().toLowerCase())};var d=function(k,j){if((!k)||k.length<=0||(!j)){return true}var l=h.call(null,j);if(f.inArray(l,k)<=-1){return false}return true};var e=function(m){var n=f(this),l=n.data(g),p=0;if(!l){f.error("uploadfile not init");return n}var j=new b(),k=f.extend(true,{},l.data,m),o=true;n.each(function(s){var r=f(this),u=r.get(0).files,q=r.attr("name");if((!u)||u.length<=0||(!r.val())){o=false;return false}for(var t=u.length-1;t>=0;t--){j.append(q+(p<=0?"":(p+"")),u[t]);p++}j.append("filepath"+(s<=0?"":s),r.val())});if(!o){return n}if(k){f.each(k,function(r,q){j.append(r,q)})}f.ajax({url:l.url,dataType:l.dataType,method:"post",data:j,timeout:l.timeout,processData:false,contentType:false,beforeSend:function(q){l.before.call(null,q)}}).done(function(q){l.success.call(null,q)}).fail(function(q){l.error.call(null,q)}).always(function(q){l.complete.call(null,q)});return n};var a=function(){var k=f(this),j=k.data(g);if(!d.call(null,j.accept,k.val())){j.selectError.call(k,k.val());k.val("");k.click()}return k};var i=function(){var k=f(this),j=k.data(g);if(k.val()){if(d.call(null,j.accept,k.val())){return e.call(this)}}return k};var c={init:function(j){var m=f.extend(true,{},f.fn.uploadfile.defaults,j),n=f(this);n.attr("required","required");n.attr("type","file");if(!m.file){if(!n.attr("name")){m.file="file"}else{m.file=n.attr("name")}}n.attr("name",m.file);if(m.accept&&m.accept.length>0){if(typeof(m.accept)==typeof([])){n.attr("accept",m.accept.join(",").toLowerCase());for(var l=m.accept.length-1;l>=0;l--){m.accept[l]=m.accept[l].toLowerCase()}}else{if(typeof(m.accept)==typeof("")&&m.accept){n.attr("accept",m.accept);m.accept=m.accept.toLowerCase().split(",")}else{m.accept=[];f.error("The options item accept type must be Array or string")}}}else{var k=n.attr("accept");m.accept=k&&k.toLowerCase().split(",")}n.data(g,m);n.off("change",a);n.on("change",a);n.off("change",i);if(m.autoUpload===true){n.on("change",i)}n.val("");return n},upload:function(j){var k=f(this);if(!k.val()){k.data(g).emptyError.call(null);return k}return e.call(this,j)},destroy:function(){return f(this).each(function(){var j=f(this);j.removeData(g)})}};f.fn.uploadfile=function(){if(!b||typeof(b)!="function"){f.error("Your browser is not support jQuery."+g);return this}var k=f(this),l=arguments[0],j;if(l===false){l=c.destroy;j=[]}else{if(typeof(l)=="object"||!l){l=c.init;j=arguments}else{if(l===true){l=c.upload;j=Array.prototype.slice.call(arguments,1)}else{if(c[l]){l=c[l];j=Array.prototype.slice.call(arguments,1)}else{f.error("Method "+l+" does not exist on jQuery."+g);return this}}}}return l.apply(this,j)};f.fn.uploadfile.defaults={url:"/",file:"file",accept:[],timeout:6000000,autoUpload:false,dataType:"json",data:{},selectError:function(j){alert("The file ["+j+"] not accept");return false},emptyError:function(){alert("Your must chose a file upload");f.error("Your must chose a file upload");return false},before:function(j){console.info("before upload file")},error:function(j){console.error("upload file error")},success:function(j){console.info("upload file success")},complete:function(j){console.info("upload file complete")}}})(jQuery,FormData);